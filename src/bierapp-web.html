<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<!--<link rel="import" href="../bower_components/app-route/app-location.html">-->
<!--<link rel="import" href="../bower_components/app-route/app-route.html">-->

<link rel="import" href="../lib/jsorolla/src/lib/opencga/variant/variant-browser.html">

<link rel="import" href="components/opencga-login.html">
<link rel="import" href="welcome.html">
<link rel="import" href="jso-styles.html">

<dom-module id="bierapp-web">

    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .center {
                margin: auto;
                text-align: justify;
                width: 60%;
                font-size: 18px;
                color: #797979;
            }

            .footer {
                text-align: center;
                color: #9d9d9d;
            }
        </style>

        <div>
            <div style="height: 60px;">
                <nav class="navbar navbar-inverse navbar-fixed-top ">
                    <div class="container-fluid">

                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header bierapp-menu">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a href="#home" class="navbar-brand" style="padding-top: 5px">
                                <img src="{{config.logo}}" width="40px">
                            </a>
                            <a class="navbar-brand" href="#home"><b>{{config.title}} {{config.version}}</b></a>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <!-- Controls aligned to the LEFT -->
                            <ul class="nav navbar-nav">
                                <!--<li class="dropdown">-->
                                <!--<a href="#home"><span class="fa fa-home" aria-hidden="true"></span></a>-->
                                <!--</li>-->

                                <li class="bierapp-menu"><a href="#home" role="button">Home</a></li>

                                <template is="dom-if" if="{{isBrowserVisible}}">
                                    <!--<li class="bierapp-menu"><a href="#browser" role="button">Variant Browser</a></li>-->
                                    <li class="bierapp-menu"><a href="#browser" role="button">{{config.menu.browser.title}}</a></li>
                                </template>

                                <template is="dom-if" if="{{isPrioritizationVisible}}">
                                    <li class="bierapp-menu"><a href="#prioritization" role="button">{{config.menu.prioritization.title}}</a></li>
                                </template>

                                <template is="dom-if" if="{{isDiagnoseVisible}}">
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{config.menu.diagnose.title}} <span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <li on-click=""><a href="#" data-id="sample">Sample</a></li>
                                            <li on-click=""><a href="#" data-id="family">Family</a></li>
                                        </ul>
                                    </li>
                                </template>

                                <template is="dom-if" if="{{isBeaconVisible}}">
                                    <li class="bierapp-menu"><a href="#beacon" role="button">Beacon</a></li>
                                </template>

                                <template is="dom-if" if="{{isToolsVisible}}">
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{config.menu.tools.title}} <span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <li on-click=""><a href="#" data-id="sample">IBS</a></li>
                                            <li on-click=""><a href="#" data-id="family">Export</a></li>
                                        </ul>
                                    </li>
                                </template>

                                <template is="dom-if" if="{{isGenomeBrowserVisible}}">
                                    <li class="bierapp-menu"><a href="#genomeBrowserPanel" role="button">{{config.menu.genomeBrowser.title}} </a></li>
                                </template>
                            </ul>


                            <!-- Controls aligned to the RIGHT: settings and about-->
                            <ul class="nav navbar-nav navbar-right">

                                <template is="dom-if" if="{{logged}}">
                                    <li><a href="#" role="button">Logged as '{{userId}}'</a></li>

                                    <!-- About dropdown menu-->
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Projects <span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <template is="dom-repeat" items="{{projects}}">
                                                <li on-click="selectProject"><a href="#" data-id="{{item.id}}">{{item.name}}</a></li>
                                            </template>
                                        </ul>
                                    </li>

                                    <li><a href="#" role="button">My Data</a></li>

                                    <li class="bierapp-menu-vertical-right"><a href="#browser" role="button">Upload data</a></li>
                                    <li class="divider-vertical"></li>

                                </template>


                                <!-- Setting modal window -->
                                <template is="dom-if" if="{{config.settingsShow}}">
                                    <li>
                                        <a href="#" data-toggle="modal" role="button" data-placement="bottom" data-target="#myModal" title="Settings ...">
                                            <i class="fa fa-cog"></i>
                                        </a>
                                    </li>
                                </template>

                                <!-- About dropdown menu-->
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <template is="dom-repeat" items="{{config.about}}">
                                            <li><a href="{{item.url}}" target="_blank"><i class$="{{item.icon}}" aria-hidden="true"></i> {{item.name}}</a></li>
                                        </template>
                                        <!--<li><a href="https://github.com/babelomics/bierapp/wiki" target="_blank"><i class="fa fa-book" aria-hidden="true"></i> Documentation</a></li>-->
                                        <!--<li><a href="https://github.com/babelomics/bierapp/wiki/Tutorial" target="_blank"> Tutorial</a></li>-->
                                        <!--<li><a href="https://github.com/babelomics/bierapp" target="_blank"><i class="fa fa-github" aria-hidden="true"></i> Source code</a></li>-->
                                        <!--<li><a href="#"><i class="fa fa-envelope" aria-hidden="true"></i> Contact</a></li>-->
                                        <!--<li><a href="#"> FAQ</a></li>-->
                                    </ul>
                                </li>

                                <!-- Login/Logout button -->
                                <li class="bierapp-menu">
                                    <a href="#login" data-toggle="modal" role="button" data-placement="bottom" data-target="#ModalLogin" title="Login ...">
                                        <i class="fa fa-sign-in fa-lg"></i> Login
                                    </a>
                                    <a href="#logout" on-click="logout" style="display: none;">
                                        <i class="fa fa-sign-out fa-lg"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
            <!-- End of navigation bar -->



            <!-- This is where main application is rendered -->
            <div class="center">
                <!--<div class="collapse content" id="home">-->
                <!--<br>-->
                <!--<img src="images/bier-text.svg">-->
                <!--<span style="font-size:50px;">BiERapp v2.0.0</span>-->
                <!--<h2>Overview</h2>-->
                <!--<p>-->
                <!--Welcome to the gene/variant prioritization tool of the BIER (the Team of BioInformatic for Rare Diseases). This interactive tool allows finding genes affected by deleterious variants that segregate along family pedigrees, case-controls or sporadic samples.-->
                <!--</p>-->
                <!--<br>-->
                <!--<p>-->
                <!--<div>Supported by</div>-->
                <!--<img style="margin:3px;height:35px;" src="images/logobier.jpg" />-->
                <!--<img style="margin:3px;height:35px;" src="images/logo_ciberer.jpg" />-->
                <!--<img style="margin:3px;height:35px;" src="images/logo_cipf.png" />-->
                <!--<img style="margin:3px;height:35px;" src="images/logoBabelomics_positive_trans.svg" />-->
                <!--<img style="margin:3px;height:35px;" src="images/LOGO_Micinn_Isciii.jpg" />-->
                <!--<img style="margin:3px;height:35px;" src="images/logo_inb.png" />-->
                <!--</p>-->
                <!--<br>-->
                <!--<div>Note:</div>-->
                <!--<span style="font-size:13px">{{versionNav}}-->
                <!--<br> BierApp web application makes an intensive use of the HTML5 standard and other cutting-edge web technologies such as Web Components, so only modern web browsers are fully supported, these include Chrome 36+, Firefox 32+, IE 10+, Safari-->
                <!--7+ and Opera 24+.-->
                <!--</span>-->
                <!--</div>-->
                <div class="collapse content" id="home">
                    <welcome-web></welcome-web>
                </div>
            </div>


            <div class="">
                <div class="collapse content" id="browser">
                    <variant-browser title="browser" host="{{host}}" project="{{project}}" study="{{study}}" studies="{{studies}}" opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"></variant-browser>
                </div>

                <div class="collapse content" id="prioritization">
                    <variant-browser title="prioritization" host="{{host}}" project="{{project}}" study="{{study}}" studies="{{studies}}" opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"></variant-browser>
                </div>

                <div class="collapse content" id="genomeBrowserPanel">
                    no yet :-(
                </div>

                <!--BreadCrumb reference-->
                <div class="collapse content" id="projectList">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Project</th>
                            <th>Studies</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{projects}}">
                            <tr>
                                <td on-click="showProjectSummary">{{item.name}}</td>
                                <td>
                                    <template is="dom-repeat" items="{{item.studies}}" as="study">
                                        {{study.name}}<br>
                                    </template></td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>

                <div class="collapse content" id="projectSummary">
                    <h4><b>Project:</b> {{selectedProject.name}}</h4> <br>
                    <b>Studies:</b> <br>
                    <template is="dom-repeat" items="{{selectedProject.studies}}" as="study">
                        {{study.name}}<br>
                    </template>
                    <b>Alias:</b> {{selectedProject.alias}} <br>
                    <b>ID:</b> {{selectedProject.id}} <br>
                    <b>Creation Date:</b> {{selectedProject.creationDate}}<br>
                    <b>Organization:</b> {{selectedProject.organization}}
                </div>
            </div>
            <!--<nav class="footer navbar navbar-inverse navbar-fixed-bottom">-->
            <!--<div class="bierapp-menu">-->
            <!--<br> BierApp: created by the Computational Genomics Department-->
            <!--<br> Centro de Investigación Principe Felipe, Valencia 2016-->
            <!--</div>-->
            <!--</nav>-->
        </div>



        <!-- Login modal window -->
        <div class="center">
            <div class="collapse content" id="login">
                <div class="modal fade" id="ModalLogin" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLogin">Login</h4>
                            </div>
                            <div class="modal-body">
                                <opencga-login on-login="login" opencga-client="{{opencgaClient}}" opencga-client-config="{{opencgaClientConfig}}" login-text="Sign in"></opencga-login>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal dialog for Settings -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Settings</h4>
                    </div>
                    <div class="modal-body">
                        <p></p>
                        <div class="input-group">
                            <span class="input-group-addon" id="opencga-host">OpenCGA</span>
                            <input type="text" class="form-control" placeholder="Username" aria-describedby="basic-addon1" value="http://bioinfo.hpc.cam.ac.uk/opencga">
                        </div>
                        <p></p>
                        <div class="input-group">
                            <span class="input-group-addon" id="cellbase-host">CellBase </span>
                            <input type="text" class="form-control" placeholder="Username" aria-describedby="basic-addon1" value="http://bioinfo.hpc.cam.ac.uk/cellbase">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">OK</button>
                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'bierapp-web',
            properties: {
                cellbaseClient: {
                    type: Object
                },
                host: {
                    type: String,
                    value: "http://bioinfodev.hpc.cam.ac.uk/hgva"
                },
                userId: {
                    type: String,
                    value: ""
                },
                project: {
                    type: String,
                    value: ""
                },
                study: {
                    type: Object
                },
                studies: {
                    type: Array,
                    value: []
                },
                logged: {
                    type: Boolean,
                    value: false
                }
            },
            ready: function() {
                this.config = application;
                console.log(this.config)

                var _this = this;
                window.onhashchange = function () {
                    _this.listener(_this);
                };

                this._checkVersion();
                this.enableClick();

                this.opencgaClientConfig = new OpenCGAClientConfig(OPENCGA_HOST, OPENCGA_VERSION, OPENCGA_COOKIE_SESSION_ID, OPENCGA_COOKIE_USER_NAME);
                this.opencgaClient = new OpenCGAClient(this.opencgaClientConfig);

                this.cellBaseClientConfig = new CellBaseClientConfig(hosts = ["bioinfodev.hpc.cam.ac.uk/cellbase-dev-v4.0"], version = "v4");
                this.cellbaseClient = new CellBaseClient(this.cellBaseClientConfig);

                var sid = Cookies.get("opencga_sId");
                if (typeof sid !== "undefined" && sid != "") {
                    this.userId = Cookies.get("opencga_userId");
                    this.sessionId = sid;
                    this.startApp();
                    this.showLogout()
                }

                // if has exist use hash, else go to #home
                if (window.location.hash != "") {
                    var arr = window.location.hash.split('/');
                    if (arr.length > 0) {
                        this.project = arr[1];
                        if (arr.length > 1) {
                            this.study = {name: arr[2]};
                        }
                    }
                    $('.content').hide();
                    $(arr[0]).show();
                } else {
                    $('#home').show();
                }

                this._setVisibleMenuItems();
            },
            listener: function (ctx) {
                var arr = window.location.hash.split('/');
                if (typeof $(arr[0])[0] !== "undefined") {
                    let isBlock = $(arr[0])[0].style.display == 'block';
                    if (!isBlock) {
                        if (arr.length > 0) {
                            ctx.project = arr[1];
                            if (arr.length > 1) {
                                ctx.study = {id: arr[2], name: arr[2]};
                            }
                        }
                        console.log('ctx.project', ctx.project)
                        console.log('ctx.study', ctx.study)
                        $('.content').hide();
                        $(arr[0]).show();
                    }
                }
            },
            _setVisibleMenuItems: function () {
                let menuItems = this.config.menu;
                for (var item in menuItems) {
                    let visibility = menuItems[item].visibility;
                    let visible = false;
                    switch(visibility) {
                        case 'public':
                            visible = true;
                            break;
                        case 'private':
                            visible = false;
                            break;
                        case 'never':
                            visible = false;
                            break;
                    }
                    switch(item) {
                        case 'browser':
                            this.isBrowserVisible = visible;
                            break;
                        case 'prioritization':
                            this.isPrioritizationVisible = visible;
                            break;
                        case 'diagnose':
                            this.isDiagnoseVisible = visible;
                            break;
                        case 'beacon':
                            this.isBeaconVisible = visible;
                            break;
                        case 'tools':
                            this.isToolsVisible = visible;
                            break;
                        case 'genomeBrowser':
                            this.isGenomeBrowserVisible = visible;
                            break;
                    }
                }
            },
            enableClick: function() {
                let _this = this;
                $(".bierapp-menu a").on('click', function(e) {
                    e.preventDefault(); // stops link form loading
                    $('.content').hide(); // hides all content divs
                    $($(this).attr('href')).show(); //get the href and use it find which div to show
                    window.location.hash = $(this).attr('href') + "/" + _this.project; // changes the hash value in the address bar
                });
            },
            disableClick: function() {
                $(".bierapp-menu a").off('click');
            },
            showLogin: function() {
                $(".bierapp-menu a[href='#logout']").hide();
                $(".bierapp-menu a[href='#login']").removeAttr("style");
            },
            showLogout: function() {
                $(".bierapp-menu a[href='#login']").hide();
                $(".bierapp-menu a[href='#logout']").removeAttr("style");
            },
            login: function(e) {
                this.enableClick();
                //                $(".bierapp-menu a[href='#home']").trigger("click");
                this.showLogout();
                $('#home').show();
                window.location.hash = 'home'; // Setting the hash value in the address bar to home after login

                this.userId = e.detail.userId;
                this.sessionId = e.detail.sessionId;

                this.startApp();
            },
            startApp: function() {
                this.logged = true;
                // Making the private menu items visible after login
                this.isPrioritizationVisible = true;
                this.isDiagnoseVisible = true;
                console.log(this.sessionId)
                console.log(this.opencgaClient)
                this.opencgaClient._config.sessionId = this.sessionId;

                var _this = this;
                this.opencgaClient.users().projects(this.userId).then(function(response) {
                    _this.projects = response.response[0].result;
                    _this.selectProject(_this.projects[0].name);
                });
            },
            selectProject: function(e) {
                if (typeof e.target === "undefined") {
                    this.project = e;
                } else {
                    this.project = e.target.innerText;
                }
                this.studies = [];
                for (let i = 0; i < this.projects.length; i++) {
                    if (this.projects[i].name == this.project) {
                        for (let j = 0; j < this.projects[i].studies.length; j++) {
                            this.push('studies', this.projects[i].studies[j]);
                        }
                        this.selectedProject = this.projects[i];
                    }
                }
            },
            showProjectSummary: function (e) {
                e.preventDefault();
                $('.content').hide();
                $('#projectSummary').show();
            },
            logout: function() {
                var _this = this;
                this.opencgaClient.users().logout().then(function() {
                    _this.showLogin();
                    //                    $(".bierapp-menu a[href='#login']").trigger("click");
                    $('#home').show();
                    //                    _this.disableClick();
                    window.location.hash = 'home'; // Setting the hash value in the address bar to home after logout
                    _this.opencgaClient = undefined;
                    _this.userId = "";
                    _this.logged = false;
                    _this.isPrioritizationVisible = false;
                    _this.isDiagnoseVisible = false;
                });
            },
            _checkVersion: function() {
                this.versionNav = "You are currently using ";
                var nav = navigator.userAgent.toLowerCase();
                if (/opr\/(\d+\.?)+/.test(nav)) {
                    var aux = /opr\/((\d+\.?)+)/.exec(nav);
                    this.versionNav += aux[0].replace("opr", "Opera");
                } else if (/firefox\/(\d+\.?)+/.test(nav)) {
                    var aux = /firefox\/((\d+\.?)+)/.exec(nav);
                    this.versionNav += aux[0];
                } else if (/msie (\d+\.?)+/.test(nav) || /rv\:(\d+\.?)+/.test(nav)) {
                    var aux = /msie ((\d+\.?)+)/.exec(nav);
                    if (aux == null) {
                        aux = /rv\:((\d+\.?)+)/.exec(nav);
                        this.versionNav += aux[0].replace("rv:", "Internet Explorer");
                    } else {
                        this.versionNav += aux[0].replace("msie", "Internet Explorer");
                    }
                } else if (/safari\/(\d+\.?)+/.test(nav) && nav.indexOf("chrome") == -1) {
                    var aux = /safari\/((\d+\.?)+)/.exec(nav);
                    this.versionNav += aux[0];
                } else if (/chrome\/(\d+\.?)+/.test(nav)) {
                    var aux = /chrome\/((\d+\.?)+)/.exec(nav);
                    this.versionNav += aux[0];
                } else {
                    this.versionNav = "You are currently using an unsupported browser";
                }
                if (nav.indexOf("_64") >= 0) {
                    this.versionNav += " (64-bits)"
                } else if (nav.indexOf("_32") >= 0) {
                    this.versionNav += " (32-bits)"
                }
            }
        });
    </script>
</dom-module>
